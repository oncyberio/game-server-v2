<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://unpkg.com/colyseus.js@^0.15.0/dist/colyseus.js"></script>
    <title>Simple 2D Square Movement Game with Smooth Motion</title>
    <style>
      body {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        background-color: #f0f0f0;
        font-family: Arial, sans-serif;
      }
      #gameArea {
        width: 400px;
        height: 300px;
        background-color: #4a4a4a;
        position: relative;
        overflow: hidden;
      }
      .player {
        width: 30px;
        height: 30px;
        background-color: #ff6b6b;
        position: absolute;
        left: 185px;
        top: 135px;
      }
      .remotePlayer {
        background-color: #6bd4ff;
      }
      #instructions {
        text-align: center;
        margin-top: 20px;
        color: #333;
      }
    </style>
  </head>
  <body>
    <div>
      <div id="gameArea">
        <div id="player" class="player"></div>
      </div>
      <div id="instructions">Use arrow keys to move the square</div>
      <div id="choose-color">
        <input type="color" id="color" />
        <button id="change-color">Change Color</button>
      </div>
    </div>

    <script type="module">
      //
      let lastPayload = {
        x: null,
        y: null,
        state: null,
      };
      const players = new Map();
      const localPlayer = document.getElementById("player");
      const gameArea = document.getElementById("gameArea");

      const btnChangeColor = document.getElementById("change-color");
      const colorInput = document.getElementById("color");

      let playerX = 185 + Math.random() * 100;
      let playerY = 135 + Math.random() * 100;
      // random color
      let color = "#" + Math.floor(Math.random() * 16777215).toString(16);
      let targetX = playerX;
      let targetY = playerY;
      const speed = 0.1; // Lowered for smoother movement
      const keys = {};

      var client = new Colyseus.Client("http://localhost:2567");

      client
        .joinOrCreate("cyber-game", {
          userId: "yassine",
          name: "Yassine Elouafi",
        })
        .then((room) => {
          console.log("joined successfully", room);
          room.onStateChange((state) => {
            console.log("onStateChange", state.toJSON());
            syncPlayers(room, state.players);
          });
          setInterval(() => {
            sendPayload(room);
          }, 1000 / 20);
        })
        .catch((e) => {
          console.error("join error", e);
        });

      btnChangeColor.addEventListener("click", () => {
        localPlayer.style.backgroundColor = colorInput.value;
        color = colorInput.value;
      });

      colorInput.value = color;

      localPlayer.style.backgroundColor = color;

      function sendPayload(room) {
        if (
          lastPayload.x !== targetX ||
          lastPayload.y !== targetY ||
          lastPayload.state !== color
        ) {
          lastPayload = {
            x: targetX,
            y: targetY,
            state: color,
          };
          room.send("@cyber/msg", {
            type: 100, // GAME_MESSAGE
            data: lastPayload,
          });
        }
      }

      function syncPlayers(room, serverPlayers) {
        // Remove players that are no longer in the game
        for (let [id, playerElement] of players) {
          if (!serverPlayers.has(id)) {
            playerElement.remove();
            players.delete(id);
          }
        }

        // Add or update players
        serverPlayers.forEach((player) => {
          const id = player.sessionId;
          if (id !== room.sessionId) {
            if (!players.has(id)) {
              const newPlayer = document.createElement("div");
              newPlayer.className = "player remotePlayer";
              gameArea.appendChild(newPlayer);
              players.set(id, newPlayer);
            }

            const playerElement = players.get(id);
            if (playerElement) {
              playerElement.style.left = player.position.x + "px";
              playerElement.style.top = player.position.y + "px";
              playerElement.style.backgroundColor = player.state;
            }
          }
        });
      }

      function updateLocPlayerPosition() {
        playerX += (targetX - playerX) * speed;
        playerY += (targetY - playerY) * speed;

        // Ensure player stays within boundaries
        playerX = Math.max(
          0,
          Math.min(gameArea.offsetWidth - localPlayer.offsetWidth, playerX)
        );
        playerY = Math.max(
          0,
          Math.min(gameArea.offsetHeight - localPlayer.offsetHeight, playerY)
        );

        localPlayer.style.left = playerX + "px";
        localPlayer.style.top = playerY + "px";

        requestAnimationFrame(() => updateLocPlayerPosition(null));
      }

      function handleKeyDown(e) {
        keys[e.key] = true;
      }

      function handleKeyUp(e) {
        keys[e.key] = false;
      }

      function updateTargetPosition() {
        const moveDistance = 2;
        if (keys["ArrowLeft"]) targetX -= moveDistance;
        if (keys["ArrowRight"]) targetX += moveDistance;
        if (keys["ArrowUp"]) targetY -= moveDistance;
        if (keys["ArrowDown"]) targetY += moveDistance;

        // Constrain target position to game area
        targetX = Math.max(
          0,
          Math.min(gameArea.offsetWidth - localPlayer.offsetWidth, targetX)
        );
        targetY = Math.max(
          0,
          Math.min(gameArea.offsetHeight - localPlayer.offsetHeight, targetY)
        );

        requestAnimationFrame(updateTargetPosition);
      }

      document.addEventListener("keydown", handleKeyDown);
      document.addEventListener("keyup", handleKeyUp);

      updateLocPlayerPosition();
      updateTargetPosition();
    </script>
  </body>
</html>
